<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









  
  
  <link rel="stylesheet" media="all" href="/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.4">



  <link rel="icon" type="image/png" sizes="16x16" href="/favicon/12.ico?v=6.0.4">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.4" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Linux," />


<meta name="description" content="驱动实验之三——关于tasklet和工作队列的学习">
<meta name="keywords" content="Linux">
<meta property="og:type" content="article">
<meta property="og:title" content="定时器&amp;&amp;tasklet&amp;&amp;工作队列">
<meta property="og:url" content="https://www.prime666.com/2017/06/03/定时器/index.html">
<meta property="og:site_name" content="Prime&#39;s Blog">
<meta property="og:description" content="驱动实验之三——关于tasklet和工作队列的学习">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-07-04T02:41:54.525Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="定时器&amp;&amp;tasklet&amp;&amp;工作队列">
<meta name="twitter:description" content="驱动实验之三——关于tasklet和工作队列的学习">






  <link rel="canonical" href="https://www.prime666.com/2017/06/03/定时器/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>定时器&&tasklet&&工作队列 | Prime's Blog</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Prime's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">弱菜的进化~</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />Categories</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />Commonweal 404</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.prime666.com/2017/06/03/定时器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Prime">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/avatar/misaka.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Prime's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">定时器&&tasklet&&工作队列</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-03T10:31:13+08:00">2017-06-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/编程/" itemprop="url" rel="index"><span itemprop="name">编程</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon"
            >
            <i class="fa fa-eye"></i>
             Views: 
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>驱动实验之三——关于tasklet和工作队列的学习</p>
<a id="more"></a>
<h1 id="tasklet和工作队列"><a href="#tasklet和工作队列" class="headerlink" title="tasklet和工作队列"></a>tasklet和工作队列</h1><h2 id="定时器"><a href="#定时器" class="headerlink" title="定时器"></a>定时器</h2><p>为了下面的实验，首先需要设置内核定时器。</p>
<p>在头文件<code>&lt;linux/timer.h&gt;</code>中定义了一个内核定时器。其是一个结构体，部分成员如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> timer_list</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> list_head <span class="built_in">list</span>;</div><div class="line">　　<span class="keyword">unsigned</span> <span class="keyword">long</span> expires; <span class="comment">//定时器到期时间,节拍数</span></div><div class="line">　　<span class="keyword">unsigned</span> <span class="keyword">long</span> data; <span class="comment">//作为参数被传入定时器处理函数</span></div><div class="line">　　<span class="keyword">void</span> (*function)(<span class="keyword">unsigned</span> <span class="keyword">long</span>);<span class="comment">//定时处理函数</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>首先说明一下，<code>jiffies</code>在内核中是一个全局变量，它用来统计系统自启动以来系统中产生的总节拍(系统中连续两次时钟中断的间隔时间)数，这个变量定义在<code>&lt;linux/sched.h&gt;</code>中。该变量在系统启动时被初始化为0，接下来没进行一次时钟中断，jiffies自动加1。因此，知道了总的节拍数，然后再除以Hz，即可知系统的运行时间（jiffies/Hz）。</p>
<p>内核提供了一些方法进行转换:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;linux/jiffies.h&gt;</span> </span></div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">jiffies_to_msecs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> j)</span></span>;  </div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">jiffies_to_usecs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> j)</span></span>;  </div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">msecs_to_jiffies</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> m)</span></span>;  </div><div class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">usecs_to_jiffies</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> u)</span></span>;</div></pre></td></tr></table></figure>
<p>其余方法:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//初始化定时器：</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_timer</span><span class="params">(<span class="keyword">struct</span> timer_list * timer)</span></span>;</div><div class="line"><span class="comment">//增加定时器：</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_timer</span><span class="params">(<span class="keyword">struct</span> timer_list * timer)</span></span>;</div><div class="line"><span class="comment">//删除定时器：</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">del_timer</span><span class="params">(<span class="keyword">struct</span> timer_list * timer)</span></span>;</div><div class="line"><span class="comment">//修改定时器的expire,可以用于重复计时</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">mod_timer</span><span class="params">(<span class="keyword">struct</span> timer_list *timer, <span class="keyword">unsigned</span> <span class="keyword">long</span> expires)</span></span>;</div></pre></td></tr></table></figure>
<p>由此实现一个定时器如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span><span class="comment">//jiffies在此头文件中定义</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/timer.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/jiffies.h&gt;</span></span></div><div class="line"><span class="keyword">struct</span> timer_list mytimer;<span class="comment">//定义一个定时器</span></div><div class="line"><span class="function"><span class="keyword">void</span>  <span class="title">mytimer_ok</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></div><div class="line">&#123;</div><div class="line">    mod_timer(&amp;mytimer,msecs_to_jiffies(<span class="number">1000</span>)+jiffies);</div><div class="line">    printk(<span class="string">"Mytimer is ok\n"</span>);</div><div class="line">    printk(<span class="string">"receive data from timer: %d\n"</span>,arg);</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">hello_init</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"hello,world\n"</span>);</div><div class="line">    init_timer(&amp;mytimer);     <span class="comment">//初始化定时器</span></div><div class="line">    mytimer.expires = msecs_to_jiffies(<span class="number">1000</span>)+jiffies;<span class="comment">//设定超时时间，100代表1秒</span></div><div class="line">    mytimer.data = <span class="number">250</span>;    <span class="comment">//传递给定时器超时函数的值</span></div><div class="line">    mytimer.function = mytimer_ok;<span class="comment">//设置定时器超时函数</span></div><div class="line">    add_timer(&amp;mytimer); <span class="comment">//添加定时器，定时器开始生效</span></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">hello_exit</span> <span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    del_timer(&amp;mytimer);<span class="comment">//卸载模块时，删除定时器</span></div><div class="line">    printk(<span class="string">"Hello module exit\n"</span>);</div><div class="line">&#125;</div><div class="line"> </div><div class="line">module_init(hello_init);</div><div class="line">module_exit(hello_exit);</div><div class="line">MODULE_AUTHOR(<span class="string">"prime"</span>);</div><div class="line">MODULE_LICENSE(<span class="string">"Dual BSD/GPL"</span>);</div></pre></td></tr></table></figure>
<h2 id="tasklet"><a href="#tasklet" class="headerlink" title="tasklet"></a>tasklet</h2><h3 id="理论概述"><a href="#理论概述" class="headerlink" title="理论概述"></a>理论概述</h3><p>软中断、tasklet和工作队列并不是Linux内核中一直存在的机制，而是由更早版本的内核中的“下半部”（bottom half）演变而来。</p>
<ul>
<li>上半部和下半部的区别？</li>
</ul>
<blockquote>
<p><strong>上半部指的是中断处理程序，下半部则指的是一些虽然与中断有相关性但是可以延后执行的任务</strong>。举个例子：在网络传输中，网卡接收到数据包这个事件不一定需要马上被处理，适合用下半部去实现；但是用户敲击键盘这样的事件就必须马上被响应，应该用中断实现。</p>
<p>两者的主要区别在于：中断不能被相同类型的中断打断，而下半部依然可以被中断打断；中断对于时间非常敏感，而下半部基本上都是一些可以延迟的工作。由于二者的这种区别，所以对于一个工作是放在上半部还是放在下半部去执行，可以参考下面四条：</p>
<p>a）如果一个任务对时间非常敏感，将其放在中断处理程序中执行。</p>
<p>b）如果一个任务和硬件相关，将其放在中断处理程序中执行。</p>
<p>c）如果一个任务要保证不被其他中断（特别是相同的中断）打断，将其放在中断处理程序中执行。</p>
<p>d）其他所有任务，考虑放在下半部去执行。</p>
</blockquote>
<ul>
<li>为何使用软中断？</li>
</ul>
<blockquote>
<p>软中断作为下半部机制的代表，是随着SMP（share memory processor）的出现应运而生的，它也是tasklet实现的基础（tasklet实际上只是在软中断的基础上添加了一定的机制）。软中断一般是“<strong>可延迟函数</strong>”的总称，有时候也包括了tasklet（请读者在遇到的时候根据上下文推断是否包含tasklet）。它的出现就是因为要满足上面所提出的上半部和下半部的区别，使得对时间不敏感的任务延后执行，而且可以在多个CPU上并行执行，使得总的系统效率可以更高。它的特性包括：</p>
<p>a）产生后并不是马上可以执行，必须要等待内核的调度才能执行。软中断不能被自己打断，只能被硬件中断打断（上半部）。</p>
<p>b）可以并发运行在多个CPU上（即使同一类型的也可以）。所以软中断必须设计为可重入的函数（允许多个CPU同时操作），因此也需要使用自旋锁来保护其数据结构。</p>
</blockquote>
<ul>
<li>tasklet和软中断的区别</li>
</ul>
<blockquote>
<p>由于软中断必须使用可重入函数，这就导致设计上的复杂度变高，作为设备驱动程序的开发者来说，增加了负担。而如果某种应用并不需要在多个CPU上并行执行，那么软中断其实是没有必要的。因此诞生了弥补以上两个要求的tasklet。它具有以下特性：</p>
<p>a）一种特定类型的tasklet只能运行在一个CPU上，不能并行，只能串行执行。</p>
<p>b）多个不同类型的tasklet可以并行在多个CPU上。</p>
<p>c）软中断是静态分配的，在内核编译好之后，就不能改变。但tasklet就灵活许多，可以在运行时改变（比如添加模块时）。</p>
<p>tasklet是在两种软中断类型的基础上实现的，但是由于其特殊的实现机制，所以具有了这样不同于软中断的特性。而由于这种特性，所以降低了设备驱动程序开发者的负担，因此如果不需要软中断的并行特性，tasklet就是最好的选择。</p>
</blockquote>
<hr>
<h3 id="基本方法"><a href="#基本方法" class="headerlink" title="基本方法"></a>基本方法</h3><p>其关键结构体定义如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> tasklet_struct</div><div class="line">&#123;</div><div class="line">      <span class="keyword">struct</span> tasklet_struct *next;<span class="comment">//将多个tasklet链接成单向循环链表</span></div><div class="line">      <span class="keyword">unsigned</span> <span class="keyword">long</span> state;<span class="comment">//TASKLET_STATE_SCHED(Tasklet is scheduled for execution)  TASKLET_STATE_RUN(Tasklet is running (SMP only))</span></div><div class="line">      <span class="keyword">atomic_t</span> count;<span class="comment">//0:激活tasklet 非0:禁用tasklet</span></div><div class="line">      <span class="keyword">void</span> (*func)(<span class="keyword">unsigned</span> <span class="keyword">long</span>); <span class="comment">//用户自定义函数</span></div><div class="line">      <span class="keyword">unsigned</span> <span class="keyword">long</span> data;  <span class="comment">//函数参数</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>定义<code>tasklet</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">#define DECLARE_TASKLET(name, func, data) \</div><div class="line">struct tasklet_struct name = &#123; NULL, 0, ATOMIC_INIT(0), func, data &#125;</div><div class="line">//定义名字为name的激活tasklet</div><div class="line">#define DECLARE_TASKLET_DISABLED(name, func, data) \</div><div class="line">struct tasklet_struct name = &#123; NULL, 0, ATOMIC_INIT(1), func, data &#125; </div><div class="line">//定义名字为name的非激活tasklet</div><div class="line">void tasklet_init(struct tasklet_struct *t,void (*func)(unsigned long), unsigned long data)</div><div class="line">//动态初始化tasklet</div></pre></td></tr></table></figure>
<p>相关操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">tasklet_disable</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></span></div><div class="line"><span class="comment">//函数暂时禁止给定的tasklet被tasklet_schedule调度，直到这个tasklet被再次被enable；若这个tasklet当前在运行, 这个函数忙等待直到这个tasklet退出</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">tasklet_enable</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></div><div class="line"><span class="comment">//使能一个之前被disable的tasklet；若这个tasklet已经被调度, 它会很快运行。tasklet_enable和tasklet_disable必须匹配调用, 因为内核跟踪每个tasklet的"禁止次数"</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">tasklet_schedule</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></div><div class="line"><span class="comment">//调度 tasklet 执行，如果tasklet在运行中被调度, 它在完成后会再次运行; 这保证了在其他事件被处理当中发生的事件受到应有的注意. 这个做法也允许一个 tasklet 重新调度它自己</span></div><div class="line"><span class="title">tasklet_hi_schedule</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></div><div class="line"><span class="comment">//和tasklet_schedule类似，只是在更高优先级执行。当软中断处理运行时, 它处理高优先级 tasklet 在其他软中断之前，只有具有低响应周期要求的驱动才应使用这个函数, 可避免其他软件中断处理引入的附加周期.</span></div><div class="line"><span class="title">tasklet_kill</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></div><div class="line"><span class="comment">//确保了 tasklet 不会被再次调度来运行，通常当一个设备正被关闭或者模块卸载时被调用。如果 tasklet 正在运行, 这个函数等待直到它执行完毕。若 tasklet 重新调度它自己，则必须阻止在调用 tasklet_kill 前它重新调度它自己，如同使用 del_timer_sync</span></div></pre></td></tr></table></figure>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>如下实现了一个简单的tasklet，其每秒进行一次调度，10次之后停止。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/moduleparam.h&gt;</span> <span class="comment">//模块参数</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/stat.h&gt;</span> <span class="comment">//关于模块参数权限问题</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/interrupt.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span> <span class="comment">// kmalloc</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/workqueue.h&gt;</span> <span class="comment">// workqueue_struct</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/timer.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/jiffies.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span><span class="comment">//jiffies在此头文件中定义</span></span></div><div class="line"></div><div class="line"><span class="comment">//MODULE_LICENSE("GPL");</span></div><div class="line"><span class="comment">//MODULE_AURTHOR("mayuan");</span></div><div class="line"><span class="comment">//MODULE_DISCRIPTION("Maybe not a bad program?");</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> tasklet_millisecond=<span class="number">1000</span>;<span class="comment">//tasklet的计时间隔</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> workqueue_millisecond=<span class="number">5000</span>;<span class="comment">//工作队列的计时间隔</span></div><div class="line">module_param(tasklet_millisecond,<span class="keyword">int</span>,<span class="number">0644</span>);</div><div class="line"></div><div class="line"><span class="keyword">struct</span> tasklet_struct my_tasklet;<span class="comment">//tasklet结构体</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> number=<span class="number">0</span>;<span class="comment">//用于传给tasklet回调函数的参数</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> timer_list my_timer_tasklet;<span class="comment">//定时器</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">timer_tasklet_callback</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    tasklet_schedule(&amp;my_tasklet);</div><div class="line">    mod_timer(&amp;my_timer_tasklet,msecs_to_jiffies(tasklet_millisecond)+jiffies);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init_timer_tasklet</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    init_timer(&amp;my_timer_tasklet);</div><div class="line">    my_timer_tasklet.expires=msecs_to_jiffies(tasklet_millisecond)+jiffies;</div><div class="line">    my_timer_tasklet.function=timer_tasklet_callback;</div><div class="line">    add_timer(&amp;my_timer_tasklet);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">tasklet_callback</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> data)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"number:%d ------ tasklet was schedule!\n"</span>,number);</div><div class="line">    number++;</div><div class="line">    <span class="keyword">if</span> (number==<span class="number">10</span>)</div><div class="line">    &#123;</div><div class="line">        del_timer(&amp;my_timer_tasklet);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function">init <span class="title">init_my_module</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    tasklet_init(&amp;my_tasklet,tasklet_callback,<span class="number">0</span>);</div><div class="line">    printk(<span class="string">"load my module!\n"</span>);</div><div class="line">    init_timer_tasklet();</div><div class="line">    </div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">exit_my_module</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    tasklet_kill(&amp;my_tasklet);</div><div class="line">    printk(<span class="string">"unload my module!\n"</span>);</div><div class="line">&#125;</div><div class="line">module_init(init_my_module);</div><div class="line">module_exit(exit_my_module);</div></pre></td></tr></table></figure>
<h2 id="工作队列"><a href="#工作队列" class="headerlink" title="工作队列"></a>工作队列</h2><p><strong>软中断运行在中断上下文中，因此不能阻塞和睡眠，而tasklet使用软中断实现，当然也不能阻塞和睡眠。</strong></p>
<p>把推后执行的任务叫做工作（work），描述它的数据结构为work_struct ，这些工作以队列结构组织成工作队列（workqueue），其数据结构为workqueue_struct ，而工作线程就是负责执行工作队列中的工作。系统默认的工作者线程为events。<br>工作队列(work queue)是另外一种将工作推后执行的形式。工作队列可以把工作推后，交由一个内核线程去执行—这个下半部分总是会<strong>在进程上下文执行，但由于是内核线程，其不能访问用户空间</strong>。最重要特点的就是<strong>工作队列允许重新调度甚至是睡眠</strong>。</p>
<p>通常，在工作队列和软中断/tasklet中作出选择非常容易。可使用以下规则： </p>
<ul>
<li><p>如果推后执行的任务需要睡眠，那么只能选择工作队列，还支持获取信号量。 </p>
</li>
<li><p>如果推后执行的任务需要延时指定的时间再触发，那么使用工作队列，因为其可以利用timer延时(内核定时器实现)。 </p>
</li>
<li><p>如果推后执行的任务需要在一个tick之内处理，则使用软中断或tasklet，因为其可以抢占普通进程和内核线程，同时不可睡眠。 </p>
</li>
<li><p>如果推后执行的任务对延迟的时间没有任何要求，则使用工作队列，此时通常为无关紧要的任务。<br><u>实际上，工作队列的本质就是将工作交给内核线程处理，因此其可以用内核线程替换。但是内核线程的创建和销毁对编程者的要求较高，而工作队列实现了内核线程的封装，不易出错，所以我们也推荐使用工作队列。</u></p>
</li>
</ul>
<h3 id="基本方法-1"><a href="#基本方法-1" class="headerlink" title="基本方法"></a>基本方法</h3><p>“工作”的结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> work_struct &#123;</div><div class="line">    <span class="keyword">atomic_long_t</span> data; <span class="comment">//传递给工作函数的参数</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">define</span> WORK_STRUCT_PENDING 0       <span class="comment">/* T if work item pending execution */</span></span></div><div class="line">    <span class="meta">#<span class="meta-keyword">define</span> WORK_STRUCT_FLAG_MASK (3UL)</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">define</span> WORK_STRUCT_WQ_DATA_MASK (~WORK_STRUCT_FLAG_MASK)</span></div><div class="line">    <span class="keyword">struct</span> list_head entry; <span class="comment">//链表结构，链接同一工作队列上的工作。</span></div><div class="line">    <span class="keyword">work_func_t</span> func; <span class="comment">//工作函数，用户自定义实现</span></div><div class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOCKDEP</span></div><div class="line">        <span class="keyword">struct</span> lockdep_map lockdep_map;</div><div class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;;</div><div class="line"><span class="comment">//工作队列执行函数的原型：</span></div><div class="line"><span class="keyword">void</span> (*<span class="keyword">work_func_t</span>)(<span class="keyword">struct</span> work_struct *work);</div><div class="line"><span class="comment">//该函数会由一个工作者线程执行，因此其在进程上下文中，可以睡眠也可以中断。但只能在内核中运行，无法访问用户空间。此函数就是我们欲做的工作</span></div></pre></td></tr></table></figure>
<p>延迟工作结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> delayed_work &#123;</div><div class="line">    <span class="keyword">struct</span> work_struct work;</div><div class="line">    <span class="keyword">struct</span> timer_list timer; <span class="comment">//定时器，用于实现延迟处理</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>工作队列的结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> workqueue_struct &#123;</div><div class="line">    <span class="keyword">struct</span> cpu_workqueue_struct *cpu_wq; <span class="comment">//指针数组，其每个元素为per-cpu的工作队列</span></div><div class="line">    <span class="keyword">struct</span> list_head <span class="built_in">list</span>;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</div><div class="line">    <span class="keyword">int</span> singlethread; <span class="comment">//标记是否只创建一个工作者线程</span></div><div class="line">    <span class="keyword">int</span> freezeable;     <span class="comment">/* Freeze threads during suspend */</span></div><div class="line">    <span class="keyword">int</span> rt;</div><div class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOCKDEP</span></div><div class="line">        <span class="keyword">struct</span> lockdep_map lockdep_map;</div><div class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>相关API如下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">静态创建 </div><div class="line">DECLARE_WORK(name,function); //定义正常执行的工作项</div><div class="line">DECLARE_DELAYED_WORK(name,function);//定义延后执行的工作项</div><div class="line"></div><div class="line">动态创建</div><div class="line">INIT_WORK(_work, _func) //创建正常执行的工作项</div><div class="line">INIT_DELAYED_WORK(_work, _func)//创建延后执行的工作项</div><div class="line"></div><div class="line">调度默认工作队列</div><div class="line">int schedule_work(struct work_struct *work）</div><div class="line"></div><div class="line">//对正常执行的工作进行调度，即把给定工作的处理函数提交给缺省的工作队列和工作者线程。工作者线程本质上是一个普通的内核线程，</div><div class="line">在默认情况下，每个CPU均有一个类型为“events”的工作者线程，当调用schedule_work时，这个工作者线程会被唤醒去执行工作链表上的所有工作。</div><div class="line"></div><div class="line">系统默认的工作队列名称是：keventd_wq,默认的工作者线程叫：events/n，这里的n是处理器的编号,每个处理器对应一个线程。</div><div class="line">比如，单处理器的系统只有events/0这样一个线程。而双处理器的系统就会多一个events/1线程。</div><div class="line">默认的工作队列和工作者线程由内核初始化时创建：</div><div class="line">start_kernel()--&gt;rest_init--&gt;do_basic_setup--&gt;init_workqueues</div><div class="line"></div><div class="line">调度延迟工作</div><div class="line">int schedule_delayed_work(struct delayed_work *dwork,unsigned long delay)</div><div class="line"></div><div class="line">刷新缺省工作队列</div><div class="line">void flush_scheduled_work(void)</div><div class="line">//此函数会一直等待，直到队列中的所有工作都被执行。</div><div class="line"></div><div class="line">取消延迟工作</div><div class="line">static inline int cancel_delayed_work(struct delayed_work *work)</div></pre></td></tr></table></figure>
<p><strong>以上均是采用缺省工作者线程来实现工作队列，其优点是简单易用，缺点是如果缺省工作队列负载太重，执行效率会很低，这就需要我们创建自己的工作者线程和工作队列。</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">create_workqueue(name) </div><div class="line"><span class="comment">//宏定义 返回值为工作队列，name为工作线程名称。创建新的工作队列和相应的工作者线程，name用于该内核线程的命名。</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">queue_work</span><span class="params">(<span class="keyword">struct</span> workqueue_struct *wq, <span class="keyword">struct</span> work_struct *work)</span></span></div><div class="line"><span class="comment">//类似于schedule_work，区别在于queue_work把给定工作提交给创建的工作队列wq而不是缺省队列。</span></div><div class="line"></div><div class="line"><span class="keyword">int</span> <span class="title">queue_delayed_work</span><span class="params">(<span class="keyword">struct</span> workqueue_struct *wq,<span class="keyword">struct</span> delayed_work *dwork, <span class="keyword">unsigned</span> <span class="keyword">long</span> delay)</span></div><div class="line"><span class="comment">//调度延迟工作。</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> <span class="title">flush_workqueue</span><span class="params">(<span class="keyword">struct</span> workqueue_struct *wq)</span></div><div class="line"><span class="comment">//刷新指定工作队列。</span></div><div class="line"></div><div class="line"><span class="keyword">void</span> <span class="title">destroy_workqueue</span><span class="params">(<span class="keyword">struct</span> workqueue_struct *wq)</span></div><div class="line"><span class="comment">//释放创建的工作队列。</span></div></pre></td></tr></table></figure>
<h3 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h3><p>下面实现了每2秒，调度一次自定义工作队列，每一秒调度一次tasklet。每次调度时进行输出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/moduleparam.h&gt;</span> <span class="comment">//模块参数</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/stat.h&gt;</span> <span class="comment">//关于模块参数权限问题</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/interrupt.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span> <span class="comment">// kmalloc</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/workqueue.h&gt;</span> <span class="comment">// workqueue_struct</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/timer.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/jiffies.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span><span class="comment">//jiffies在此头文件中定义</span></span></div><div class="line"></div><div class="line"></div><div class="line">MODULE_LICENSE(<span class="string">"GPL"</span>);</div><div class="line">MODULE_AUTHOR(<span class="string">"Mayuan"</span>);</div><div class="line">MODULE_DESCRIPTION(<span class="string">"Maybe not a bad program?a~ha"</span>);</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> tasklet_millisecond=<span class="number">1000</span>;<span class="comment">//tasklet的计时间隔</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">int</span> workqueue_millisecond=<span class="number">2000</span>;<span class="comment">//工作队列的计时间隔</span></div><div class="line">module_param(tasklet_millisecond,<span class="keyword">int</span>,<span class="number">0644</span>);</div><div class="line"></div><div class="line"><span class="keyword">struct</span> tasklet_struct my_tasklet;<span class="comment">//tasklet结构体</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> number=<span class="number">0</span>;<span class="comment">//统计tasklet调用次数</span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> timer_list my_timer_tasklet;<span class="comment">//定时器</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> timer_list my_timer_workqueue;</div><div class="line"></div><div class="line"><span class="keyword">struct</span> workqueue_struct *my_workqueue;<span class="comment">//我的工作队列</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> </div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> work_struct work;<span class="comment">//代表正常工作的结构体</span></div><div class="line">    <span class="keyword">int</span> count;<span class="comment">//计数用</span></div><div class="line">&#125;my_work;</div><div class="line"></div><div class="line">my_work *mayuan_work;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">timer_tasklet_callback</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    tasklet_schedule(&amp;my_tasklet);</div><div class="line">    mod_timer(&amp;my_timer_tasklet,msecs_to_jiffies(tasklet_millisecond)+jiffies);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">timer_workqueue_callback</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (mayuan_work-&gt;count==<span class="number">5</span>)</div><div class="line">    &#123;</div><div class="line">        del_timer(&amp;my_timer_workqueue);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        printk(<span class="string">"count:%d "</span>,mayuan_work-&gt;count);</div><div class="line">        mayuan_work-&gt;count++;</div><div class="line">        queue_work(my_workqueue,&amp;mayuan_work-&gt;work);</div><div class="line">        mod_timer(&amp;my_timer_workqueue,msecs_to_jiffies(workqueue_millisecond)+jiffies);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init_timer_tasklet</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    init_timer(&amp;my_timer_tasklet);</div><div class="line">    my_timer_tasklet.expires=msecs_to_jiffies(tasklet_millisecond)+jiffies;</div><div class="line">    my_timer_tasklet.function=timer_tasklet_callback;</div><div class="line">    add_timer(&amp;my_timer_tasklet);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init_timer_workqueue</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    init_timer(&amp;my_timer_workqueue);</div><div class="line">    my_timer_workqueue.expires=msecs_to_jiffies(workqueue_millisecond)+jiffies;</div><div class="line">    my_timer_workqueue.function=timer_workqueue_callback;</div><div class="line">    add_timer(&amp;my_timer_workqueue);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">tasklet_callback</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> data)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"number:%d ------ tasklet was schedule!\n"</span>,number);</div><div class="line">    number++;</div><div class="line">    <span class="keyword">if</span> (number==<span class="number">10</span>)</div><div class="line">    &#123;</div><div class="line">        del_timer(&amp;my_timer_tasklet);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_function</span><span class="params">(<span class="keyword">struct</span> work_struct *work)</span></span></div><div class="line">&#123;</div><div class="line">    printk(<span class="string">"workqueue was schedule!\n"</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">create_my_workqueue</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    my_workqueue=create_workqueue(<span class="string">"mayuan's workqueue"</span>);</div><div class="line">    <span class="keyword">if</span> (!my_workqueue)</div><div class="line">    &#123;</div><div class="line">        printk(<span class="string">"mmp.fuck!create workqueue failed!\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    mayuan_work=(my_work*)kmalloc(<span class="keyword">sizeof</span>(my_work),GFP_KERNEL);</div><div class="line">    <span class="keyword">if</span> (mayuan_work)</div><div class="line">    &#123;</div><div class="line">        INIT_WORK(&amp;mayuan_work-&gt;work,my_function);</div><div class="line">        mayuan_work-&gt;count=<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        printk(<span class="string">"fuck*10086!"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function">init <span class="title">init_my_module</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    tasklet_init(&amp;my_tasklet,tasklet_callback,<span class="number">0</span>);</div><div class="line">    printk(<span class="string">"load my module! by prime\n"</span>);</div><div class="line">    init_timer_tasklet();</div><div class="line">    create_my_workqueue();</div><div class="line">    init_timer_workqueue();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> __<span class="function"><span class="built_in">exit</span> <span class="title">exit_my_module</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    tasklet_kill(&amp;my_tasklet);</div><div class="line">    flush_workqueue(my_workqueue);</div><div class="line">    destroy_workqueue(my_workqueue);</div><div class="line">    printk(<span class="string">"unload my module! by prime\n"</span>);</div><div class="line"></div><div class="line">&#125;</div><div class="line">module_init(init_my_module);</div><div class="line">module_exit(exit_my_module);</div></pre></td></tr></table></figure>
<p>本文参考自<a href="http://blog.csdn.net/godleading/article/details/52971179#t10" target="_blank" rel="noopener">CSDN博客</a>，并加以取舍。</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/02/用python进行网络编程/" rel="next" title="用python进行网络编程">
                <i class="fa fa-chevron-left"></i> 用python进行网络编程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/08/简单的字符驱动/" rel="prev" title="简单的字符驱动">
                简单的字符驱动 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTgwNC82Mzcw"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/avatar/misaka.jpg"
                alt="Prime" />
            
              <p class="site-author-name" itemprop="name">Prime</p>
              <p class="site-description motion-element" itemprop="description">Stay Hungry,Stay Foolish</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">58</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">13</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#tasklet和工作队列"><span class="nav-number">1.</span> <span class="nav-text">tasklet和工作队列</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#定时器"><span class="nav-number">1.1.</span> <span class="nav-text">定时器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tasklet"><span class="nav-number">1.2.</span> <span class="nav-text">tasklet</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#理论概述"><span class="nav-number">1.2.1.</span> <span class="nav-text">理论概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基本方法"><span class="nav-number">1.2.2.</span> <span class="nav-text">基本方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实例"><span class="nav-number">1.2.3.</span> <span class="nav-text">实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#工作队列"><span class="nav-number">1.3.</span> <span class="nav-text">工作队列</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基本方法-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">基本方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实例-1"><span class="nav-number">1.3.2.</span> <span class="nav-text">实例</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Prime</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="Total Visitors">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="Total Views">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.4"></script>



  



	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  










  





  

  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  
  

  

  

  

  

</body>
</html>
